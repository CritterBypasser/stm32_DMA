#include <Arduino.h>
#define BUFFER_SIZE     1
#define UART_BAUD       57600
#define SYSCLK_HZ       16000000UL   // Arduino STM32 default (HSI)
#define TIMER_FREQ_HZ   100

volatile uint16_t adcBuffer[BUFFER_SIZE];
volatile uint8_t dmaComplete = 0;

void UART_Init(void);
void UART_SendChar(char ch);
void UART_SendString(const char *str);
void UART_SendNumber(uint32_t num);
void Timer2_Init(void);
void ADC_DMA_Init(void);


void setup() {
    UART_Init();
    ADC_DMA_Init();
    Timer2_Init();

    UART_SendString("\r\nSTM32F401CC ADC + DMA + UART\r\n");
    UART_SendString("Baud: 57600\r\n");
    UART_SendString("Sample Rate: 100 Hz\r\n");
    UART_SendString("-----------------------------------\r\n");

    TIM2->CR1 |= TIM_CR1_CEN;   // start timer
}

void loop() {
    if (dmaComplete) {
        dmaComplete = 0;

        uint32_t adcValue = adcBuffer[0];
        uint32_t voltage_mv = (adcValue * 3300UL) / 4095UL;

        UART_SendString("ADC: ");
        UART_SendNumber(adcValue);
        UART_SendString(" | Voltage: ");
        UART_SendNumber(voltage_mv / 1000);
        UART_SendString(".");
        UART_SendNumber((voltage_mv % 1000) / 100);
        UART_SendNumber((voltage_mv % 100) / 10);
        UART_SendNumber(voltage_mv % 10);
        UART_SendString(" V\r\n");
    }
}


void UART_Init(void) {
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN;
    RCC->APB1ENR |= RCC_APB1ENR_USART2EN;

    // PA2 = TX, PA3 = RX (AF7)
    GPIOA->MODER &= ~(GPIO_MODER_MODER2 | GPIO_MODER_MODER3);
    GPIOA->MODER |=  (2 << GPIO_MODER_MODER2_Pos) |
                     (2 << GPIO_MODER_MODER3_Pos);

    GPIOA->AFR[0] &= ~(GPIO_AFRL_AFSEL2 | GPIO_AFRL_AFSEL3);
    GPIOA->AFR[0] |=  (7 << GPIO_AFRL_AFSEL2_Pos) |
                      (7 << GPIO_AFRL_AFSEL3_Pos);

    GPIOA->OSPEEDR |= (3 << GPIO_OSPEEDR_OSPEED2_Pos) |
                      (3 << GPIO_OSPEEDR_OSPEED3_Pos);

    USART2->BRR = SYSCLK_HZ / UART_BAUD;
    USART2->CR1 = USART_CR1_TE | USART_CR1_RE | USART_CR1_UE;
}

void UART_SendChar(char ch) {
    while (!(USART2->SR & USART_SR_TXE));
    USART2->DR = ch;
}

void UART_SendString(const char *str) {
    while (*str) {
        UART_SendChar(*str++);
    }
}

void UART_SendNumber(uint32_t num) {
    char buf[12];
    int i = 0;

    if (num == 0) {
        UART_SendChar('0');
        return;
    }

    while (num > 0) {
        buf[i++] = '0' + (num % 10);
        num /= 10;
    }

    while (i--) {
        UART_SendChar(buf[i]);
    }
}


void Timer2_Init(void) {
    RCC->APB1ENR |= RCC_APB1ENR_TIM2EN;

    // TIM2 clock = 16 MHz
    // 16 MHz / 16000 = 1 kHz
    // 1 kHz / 10 = 100 Hz
    TIM2->PSC = 16000 - 1;
    TIM2->ARR = 10 - 1;

    // TRGO on update event
    TIM2->CR2 |= (2 << TIM_CR2_MMS_Pos);

    TIM2->EGR |= TIM_EGR_UG;
    TIM2->SR  &= ~TIM_SR_UIF;
}


void ADC_DMA_Init(void) {
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN | RCC_AHB1ENR_DMA2EN;
    RCC->APB2ENR |= RCC_APB2ENR_ADC1EN;

    // PA0 = ADC IN0
    GPIOA->MODER |= (3 << GPIO_MODER_MODER0_Pos);

    // DMA2 Stream0 Channel0 (ADC1)
    DMA2_Stream0->CR = 0;
    while (DMA2_Stream0->CR & DMA_SxCR_EN);

    DMA2->LIFCR = 0x3D;

    DMA2_Stream0->PAR  = (uint32_t)&ADC1->DR;
    DMA2_Stream0->M0AR = (uint32_t)adcBuffer;
    DMA2_Stream0->NDTR = BUFFER_SIZE;

    DMA2_Stream0->CR =
        (0 << DMA_SxCR_CHSEL_Pos) |
        (1 << DMA_SxCR_MSIZE_Pos) |
        (1 << DMA_SxCR_PSIZE_Pos) |
        DMA_SxCR_MINC |
        DMA_SxCR_CIRC |
        (2 << DMA_SxCR_PL_Pos) |
        DMA_SxCR_TCIE;

    NVIC_EnableIRQ(DMA2_Stream0_IRQn);
    DMA2_Stream0->CR |= DMA_SxCR_EN;

    // ADC common prescaler: PCLK2 / 4
    ADC->CCR = (1 << ADC_CCR_ADCPRE_Pos);

    ADC1->CR1 = 0;
    ADC1->CR2 =
        ADC_CR2_DMA |
        ADC_CR2_DDS |
        (6 << ADC_CR2_EXTSEL_Pos) |   // TIM2 TRGO
        (1 << ADC_CR2_EXTEN_Pos);     // rising edge

    ADC1->SMPR2 = (5 << ADC_SMPR2_SMP0_Pos); // 144 cycles
    ADC1->SQR1  = 0;
    ADC1->SQR3  = 0;

    ADC1->CR2 |= ADC_CR2_ADON;
}


extern "C" void DMA2_Stream0_IRQHandler(void) {
    if (DMA2->LISR & DMA_LISR_TCIF0) {
        DMA2->LIFCR = DMA_LIFCR_CTCIF0;
        dmaComplete = 1;
    }
}
