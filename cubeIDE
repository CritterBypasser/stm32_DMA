#include "stm32f4xx.h"

#define ADC_BUF_LEN  1

volatile uint16_t adc_buf[ADC_BUF_LEN];
volatile uint8_t dma_done = 0;

void SystemClock_Config(void);
void UART2_Init(void);
void TIM2_Init(void);
void ADC_DMA_Init(void);
void UART_SendChar(char c);
void UART_SendString(const char *s);
void UART_SendNumber(uint32_t n);

int main(void)
{
    SystemClock_Config();
    UART2_Init();
    TIM2_Init();
    ADC_DMA_Init();

    UART_SendString("STM32F401 ADC-DMA-TIMER-UART OK\r\n");

    TIM2->CR1 |= TIM_CR1_CEN;   // Start timer

    while (1)
    {
        if (dma_done)
        {
            dma_done = 0;

            uint32_t val = adc_buf[0];
            uint32_t mv = (val * 3300) / 4095;

            UART_SendString("ADC=");
            UART_SendNumber(val);
            UART_SendString("  V=");
            UART_SendNumber(mv / 1000);
            UART_SendChar('.');
            UART_SendNumber((mv % 1000) / 100);
            UART_SendChar('\r');
            UART_SendChar('\n');
        }
    }
}

void SystemClock_Config(void)
{
    RCC->CR |= RCC_CR_HSION;
    while (!(RCC->CR & RCC_CR_HSIRDY));

    RCC->PLLCFGR =
        (16 << RCC_PLLCFGR_PLLM_Pos) |
        (336 << RCC_PLLCFGR_PLLN_Pos) |
        (0 << RCC_PLLCFGR_PLLP_Pos) |
        RCC_PLLCFGR_PLLSRC_HSI;

    RCC->CR |= RCC_CR_PLLON;
    while (!(RCC->CR & RCC_CR_PLLRDY));

    FLASH->ACR = FLASH_ACR_LATENCY_2WS |
                 FLASH_ACR_ICEN |
                 FLASH_ACR_DCEN;

    RCC->CFGR |= RCC_CFGR_SW_PLL;
    while ((RCC->CFGR & RCC_CFGR_SWS) != RCC_CFGR_SWS_PLL);
}
void UART2_Init(void)
{
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN;
    RCC->APB1ENR |= RCC_APB1ENR_USART2EN;

    GPIOA->MODER |= (2 << (2 * 2));      // PA2 AF
    GPIOA->AFR[0] |= (7 << (4 * 2));     // AF7

    USART2->BRR = 729;                   // 57600 @ 42MHz
    USART2->CR1 = USART_CR1_TE | USART_CR1_UE;
}

void UART_SendChar(char c)
{
    while (!(USART2->SR & USART_SR_TXE));
    USART2->DR = c;
}

void UART_SendString(const char *s)
{
    while (*s)
        UART_SendChar(*s++);
}

void UART_SendNumber(uint32_t n)
{
    char buf[10];
    int i = 0;
    if (!n) { UART_SendChar('0'); return; }
    while (n) { buf[i++] = '0' + (n % 10); n /= 10; }
    while (i--) UART_SendChar(buf[i]);
}

void TIM2_Init(void)
{
    RCC->APB1ENR |= RCC_APB1ENR_TIM2EN;

    TIM2->PSC = 8399;      // 84MHz / 8400 = 10kHz
    TIM2->ARR = 99;        // 10kHz / 100 = 100Hz

    TIM2->CR2 |= (2 << TIM_CR2_MMS_Pos); // TRGO on update
}

void ADC_DMA_Init(void)
{
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN | RCC_AHB1ENR_DMA2EN;
    RCC->APB2ENR |= RCC_APB2ENR_ADC1EN;

    GPIOA->MODER |= (3 << (2 * 0));  // PA0 analog

    DMA2_Stream0->CR = 0;
    while (DMA2_Stream0->CR & DMA_SxCR_EN);

    DMA2->LIFCR = 0x3D;

    DMA2_Stream0->PAR  = (uint32_t)&ADC1->DR;
    DMA2_Stream0->M0AR = (uint32_t)adc_buf;
    DMA2_Stream0->NDTR = ADC_BUF_LEN;

    DMA2_Stream0->CR =
        (0 << DMA_SxCR_CHSEL_Pos) |
        DMA_SxCR_MINC |
        DMA_SxCR_CIRC |
        (1 << DMA_SxCR_MSIZE_Pos) |
        (1 << DMA_SxCR_PSIZE_Pos) |
        DMA_SxCR_TCIE;

    NVIC_EnableIRQ(DMA2_Stream0_IRQn);

    DMA2_Stream0->CR |= DMA_SxCR_EN;

    ADC->CCR |= (1 << ADC_CCR_ADCPRE_Pos);

    ADC1->SMPR2 |= (5 << ADC_SMPR2_SMP0_Pos);
    ADC1->SQR3 = 0;

    ADC1->CR2 =
        ADC_CR2_DMA |
        ADC_CR2_DDS |
        (6 << ADC_CR2_EXTSEL_Pos) |
        (1 << ADC_CR2_EXTEN_Pos);

    ADC1->CR2 |= ADC_CR2_ADON;
}

void DMA2_Stream0_IRQHandler(void)
{
    if (DMA2->LISR & DMA_LISR_TCIF0)
    {
        DMA2->LIFCR |= DMA_LIFCR_CTCIF0;
        dma_done = 1;
    }
}
